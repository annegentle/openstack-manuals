<?xml version="1.0" encoding="UTF-8"?>
<section xml:id="install-glance"
    xmlns="http://docbook.org/ns/docbook"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0">
    <title>Installing and Configuring the Image Service</title>
    
    <para>Install the Image service:</para>
    <literallayout class="monospaced">sudo apt-get install glance</literallayout>
 <section xml:id="configure-glance"><title>Configuring the Image Service</title>
        <!--<para>Configure the backend data store. For MySQL, create a glance MySQL database and a glance MySQL user. Grant the "glance" user full access to the glance MySQL database.</para><para>Start the MySQL command line client by running:</para><para><literallayout class="monospaced">mysql -u root -p</literallayout></para><para>Enter the mysql root user's password when prompted.</para><para>To configure the MySQL database, create the glance database. </para><para><literallayout class="monospaced">mysql> CREATE DATABASE glance;</literallayout></para><para>Create a MySQL user for the newly-created glance database that has full control of the database. </para><para><literallayout class="monospaced">mysql> GRANT ALL ON glance.* TO 'glance'@'%' IDENTIFIED BY 'yourpassword';</literallayout></para><para>Enter quit at the mysql> prompt to exit MySQL.</para><para><literallayout class="monospaced">mysql> quit</literallayout></para>-->
    <para>Edit /etc/glance/glance-registry.conf: </para>
        <literallayout class="monospaced">sudo nano /etc/glance/glance-registry.conf</literallayout>
        <para>Here is an example glance-registry.conf file.</para>
    <para>
        <literallayout class="monospaced">[DEFAULT]
# Show more verbose log output (sets INFO log level output)
verbose = True

# Show debugging output in logs (sets DEBUG log level output)
debug = False

# Address to bind the registry server
bind_host = 0.0.0.0

# Port the bind the registry server to
bind_port = 9191

# Log to this file. Make sure you do not set the same log
# file for both the API and registry servers!
log_file = /var/log/glance/registry.log

# Send logs to syslog (/dev/log) instead of to file specified by 'log_file'
use_syslog = False

# SQLAlchemy connection string for the reference implementation
# registry server. Any valid SQLAlchemy connection string is fine.
# See: http://www.sqlalchemy.org/docs/05/reference/sqlalchemy/connections.html#sqlalchemy.create_engine
sql_connection = sqlite:////var/lib/glance/glance.sqlite

# Period in seconds after which SQLAlchemy should reestablish its connection
# to the database.
#
# MySQL uses a default 'wait_timeout' of 8 hours, after which it will drop
# idle connections. This can result in 'MySQL Gone Away' exceptions. If you
# notice this, you can lower this value to ensure that SQLAlchemy reconnects
# before MySQL can drop the connection.
sql_idle_timeout = 3600

# Limit the api to return 'param_limit_max' items in a call to a container. If
# a larger 'limit' query param is provided, it will be reduced to this value.
api_limit_max = 1000

# If a 'limit' query param is not provided in an api request, it will
# default to 'limit_param_default'
limit_param_default = 25

[pipeline:glance-registry]
pipeline = authtoken keystone_shim registryapp
# NOTE: use the following pipeline for keystone
# pipeline = authtoken keystone_shim context registryapp

[app:registryapp]
paste.app_factory = glance.registry.server:app_factory

[filter:context]
context_class = glance.registry.context.RequestContext
paste.filter_factory = glance.common.context:filter_factory

[filter:authtoken]
paste.filter_factory = keystone.middleware.auth_token:filter_factory
service_protocol = http
service_host = 127.0.0.1
service_port = 5000
auth_host = 127.0.0.1
auth_port = 35357
auth_protocol = http
auth_uri = http://127.0.0.1:5000/v2.0
admin_token = ${token}

[filter:keystone_shim]
context_class = glance.registry.context.RequestContext
paste.filter_factory = keystone.middleware.glance_auth_token:filter_factory</literallayout>
    </para>
        <para>At the bottom of the glance-registry.conf file, change
            the admin_token to the one you created with Keystone
            previously. </para>
        <para>Edit /etc/glance/glance-api.conf to update the
            admin_token (at the very bottom of the file). </para>
        <para>Edit /etc/glance/glance-api.conf: </para>
        <literallayout class="monospaced">sudo nano /etc/glance/glance-api.conf</literallayout>
        <para>Ensure that the auth sections match the ones
            below:<literallayout># ============ Delayed Delete Options =============================

# Turn on/off delayed delete
delayed_delete = False

[pipeline:glance-api]
pipeline = versionnegotiation authtoken keystone_shim apiv1app
# NOTE: use the following pipeline for keystone
# pipeline = versionnegotiation authtoken context apiv1app

# To enable Image Cache Management API replace pipeline with below:
# pipeline = versionnegotiation context imagecache apiv1app
# NOTE: use the following pipeline for keystone auth (with caching)
# pipeline = versionnegotiation authtoken context imagecache apiv1app

[pipeline:versions]
pipeline = versionsapp

[app:versionsapp]
paste.app_factory = glance.api.versions:app_factory

[app:apiv1app]
paste.app_factory = glance.api.v1:app_factory

[filter:versionnegotiation]
paste.filter_factory = glance.api.middleware.version_negotiation:filter_factory

[filter:imagecache]
paste.filter_factory = glance.api.middleware.image_cache:filter_factory

[filter:context]
paste.filter_factory = glance.common.context:filter_factory

[filter:authtoken]
paste.filter_factory = keystone.middleware.auth_token:filter_factory
service_protocol = http
service_host = 127.0.0.1
service_port = 5000
auth_host = 127.0.0.1
auth_port = 35357
auth_protocol = http
auth_uri = http://127.0.0.1:5000/v2.0
admin_token = 11121314151617181920

[filter:keystone_shim]
context_class = glance.registry.context.RequestContext
paste.filter_factory = keystone.middleware.glance_auth_token:filter_factory</literallayout></para>
        <para>Restart the glance service after changing the settings
            in the glance-registry.conf, glance-api.conf, and
            glance-scrubber.conf. </para>
      <literallayout class="monospaced">sudo restart glance-registry
sudo restart glance-api</literallayout>
    <!--<para>Create the tables in your backend data
        store:</para>
    <literallayout class="monospaced">sudo glance-manage db_sync</literallayout>-->
    <para>Now you can load your initial image. </para></section>   
</section>
